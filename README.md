# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Товар
```
export interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null;
}
```

Массив товаров с сервера
```
export interface IProductList {
  total: number;
  items: IProduct[];
}
```

Типы оплаты
```
export enum PaymentMethod {
  Online = 'online',
  Cash = 'cash'
}
```

Форма заказа (вводимые пользователем данные)
```
export interface IOrderFormState {
  payment: PaymentMethod;
  email: string;
  phone: string;
  address: string;
}
```

Заказ, отправляемый на сервер
```
export interface IOrderRequest extends IOrderFormState {
  total: number;
  items: IProduct['id'][];
}
```

Элемент корзины
```
export interface ICartItem {
  id: IProduct['id'];
  title: IProduct['title'];
  price: IProduct['price'];
}
```

Корзина
```
export interface ICart {
  items: ICartItem[];
  total: number;
}
```

Ошибки формы
```
export type FormErrors = Partial<Record<keyof IOrderFormState, string>>;
```

Типы для представления

Товар для отображения в каталоге
```
export type TProductCatalog = Pick<IProduct, 'image' | 'title' | 'category' | 'price'>;
```

Товар для отображения в карточке товара
```
export type TProductCard = Pick<IProduct, 'description' | 'image'| 'title' | 'category' | 'price'>;
```

Товар для отображения в корзине
```
export type TProductCart = Pick<IProduct, 'title' | 'price'>;
```

Первая часть оформления заказа
```
export type TOrderFirstPart = Pick<IOrderFormState, 'payment' | 'address'>;
```

Вторая часть оформления заказа
```
export type TOrderSecondPart = Pick<IOrderFormState, 'email' | 'phone'>;
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт, переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   

### Слой данных

#### Класс ProductState
Отвечает за хранение товаров и логики предпросмотра. Конструктор класса принимает инстант брокера событий

Поля:
- `products: IProduct[]` — массив товаров
- `preview: string | null` — id выбранного товара

Методы:
- `setProducts(products: IProduct[])` — сохраняет список товаров и генерирует событие `products:changed`
- `setPreview(id: string | null)` — устанавливает товар в предпросмотр и генерирует `preview:changed`
- `getProduct(id: string): IProduct | undefined` — возвращает товар по id

#### Класс CartState
Отвечает за хранение выбранных товаров и подсчёт суммы. Конструктор класса принимает инстант брокера событий

Поля:
- `items: ICartItem[]` — массив товаров в корзине

Методы:
- `add(product: IProduct)` — добавляет товар в корзину
- `remove(id: string)` — удаляет товар
- `clear()` — очищает корзину
- `has(id: string): boolean` — проверка наличия товара
- `getCart(): ICart` — возвращает корзину с total

#### Класс OrderState
Хранит форму заказа, ошибки и генерирует данные на отправку. Конструктор класса принимает инстант брокера событий

Поля:
- `form: Partial<IOrderFormState>` — вводимые пользователем поля
- `errors: FormErrors` — ошибки валидации

Методы:
- `update(data: Partial<IOrderFormState>)` — обновляет форму
- `validateStep1(): boolean` — проверяет оплату и адрес
- `validateStep2(): boolean` — проверяет email и телефон
- `getRequest(cart: ICart): IOrderRequest` — собирает финальный заказ
- `clear()` — сбрасывает состояние формы

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.  
- constructor(selector: string, events: IEvents) Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса
- modal: HTMLElement - элемент модального окна
- events: IEvents - брокер событий

#### Класс Page
Компонент, управляющий основным содержимым страницы. Отвечает за контейнер каталога, отображение состояния корзины. В конструкторе принимает DOM-контейнер страницы и экземпляр брокера событий.

#### Класс ModalPreviewProduct
Модальное окно, отображающее подробную информацию о товаре.

Поля:
- `imageElement: HTMLImageElement` — изображение товара
- `titleElement: HTMLElement` — название
- `descriptionElement: HTMLElement` — описание
- `categoryElement: HTMLElement` — категория
- `priceElement: HTMLElement` — цена
- `buyButton: HTMLButtonElement` — кнопка "В корзину"

#### Класс ModalCart
Модальное окно, отображающее содержимое корзины.

Поля:
- `listContainer: HTMLElement` — контейнер для списка товаров
- `totalElement: HTMLElement` — элемент с суммой заказа
- `checkoutButton: HTMLButtonElement` — кнопка перехода к оформлению

#### Класс ModalFirstForm
Расширяет класс Modal. Модальное окно с формой выбора способа оплаты и адреса доставки.

Поля:
- `addressInput: HTMLInputElement` — поле адреса
- `paymentRadioInputs: NodeListOf<HTMLInputElement>` — список переключателей оплаты

Методы:
- `getInputValues(): TOrderFirstPart` — возвращает заполненные данные
- `setError(...)` — отображает ошибки
- `setValid(...)` — активирует/деактивирует кнопку отправки

#### Класс ModalSecondForm
Расширяет класс Modal. Модальное окно с формой ввода email и телефона.

Поля:
- `emailInput: HTMLInputElement`
- `phoneInput: HTMLInputElement`

Методы:
- `getInputValues(): TOrderSecondPart`
- `setError(...)`
- `setValid(...)`

#### Класс ModalSuccess
Расширяет класс Modal. Модальное окно с сообщением об успешной оплате заказа.

Поля:
- `messageElement: HTMLElement` — текстовое сообщение
- `closeButton: HTMLButtonElement` — кнопка "Закрыть" или "Вернуться"

### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

### События изменения данных (генерируются классами моделей данных)

- `products:changed` — загружен новый список товаров (вызывается `ProductState.setProducts`)
- `preview:changed` — выбран товар для предпросмотра (`ProductState.setPreview`)
- `cart:changed` — изменилось содержимое корзины (добавление, удаление, очистка)
- `order:changed` — изменились поля формы оформления заказа
- `order:validated` — результат валидации формы (валидна или есть ошибки)

### События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)

- `product:select` — пользователь выбрал товар в каталоге для предпросмотра (отправляется из `CatalogItem` или аналога)
- `product:addToCart` — пользователь нажал кнопку "В корзину" в модалке товара
- `cart:open` — клик по иконке корзины в `Page`, открытие модалки с корзиной
- `cart:checkout` — переход от корзины к оформлению заказа
- `order:step1:submit` — отправка первой части формы заказа (способ оплаты и адрес)
- `order:step2:submit` — отправка второй части формы заказа (email и телефон)
- `order:completed` — заказ успешно оформлен, отображается окно успешной оплаты
- `form:input` — пользователь изменил значение в любом из полей формы